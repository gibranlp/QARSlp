#!/bin/bash
# By Lynxiayel
# Based on the script by Markus00000 at:
# https://gist.github.com/Markus00000/ad8c0ff46290f9dc2887

# This script mark current playing song as your favorite and adds it to a m3u 
# playlist which holds all your favorites.

# Path to playlists
playlists="$HOME/"

# Prefix and suffix strings for the playlist file name
pl_prefix='favorite_songs'
pl_suffix='.m3u'

# Get current song from cmus
song=$(cmus-remote -Q | grep file)

# Error cases
if [[ -z "$song" ]]; then
    echo 'No song is playing.'
    exit 1
fi

# Path to lock file
lock="/tmp/music-rate.lock"

# Lock the file (other atomic alternatives would be "ln" or "mkdir")
exec 9>"$lock"
if ! flock -n 9; then
    notify-send -t 5000 "Rating failed: Another instance is running."
    exit 1
fi

# Strip "file " from the output
song=${song/file \///}

# Temporary file for grepping and sorting
tmp="$playlists/tmp.m3u"

# # Remove the song from the fav playlists
# f="$playlists/${pl_prefix}${pl_suffix}"
# if [[ -f "$f" ]]; then
#     grep -vF "$song" "$f" > "$tmp"
#     mv -f "$tmp" "$f"
# fi

# Append the song to the fav playlist
f="$playlists/${pl_prefix}$1${pl_suffix}"
mkdir -p "$playlists"
echo "$song" >> "$f"
sort -u "$f" -o "$tmp"
mv -f "$tmp" "$f"
notify-send -t 3000 "$song added to the $pl_prefix list."

# The lock file will be unlocked when the script ends